<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025 ç¬¬å››å±†å½°åŒ–ç¸£å¥ç¥¥ç›ƒå…¨åœ‹åœæ£‹å…¬é–‹è³½ï½œè³½ç¨‹ & åæ¬¡</title>
  <style>
    body { font-family: 'Noto Sans TC','Microsoft JhengHei',system-ui,sans-serif; margin:0; padding:10px; background:#f4f7f6; color:#333; }
    .container { max-width:900px; margin:0 auto; background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    h1 { color:#2c3e50; text-align:center; margin:0 0 16px; font-size:1.8em; line-height:1.2; }
    .update-info{ text-align:center; margin-bottom:12px; font-size:.85em; color:#7f8c8d; }
    .filter-section{ display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:12px; flex-wrap:wrap; }
    .filter-section select,.filter-section button{ padding:6px 10px; border:1px solid #ccc; border-radius:6px; font-size:.9em; background:#fff; cursor:pointer; }
    .filter-section button{ background:#2e7d32; color:#fff; border:none; }
    table{ width:100%; border-collapse:collapse; margin-bottom:12px; font-size:.9em; table-layout:auto; }
    th,td{ border:1px solid #ddd; padding:6px 4px; text-align:center; vertical-align:top; white-space:normal; overflow-wrap:anywhere; word-break:break-word; line-height:1.4; background:#fdfdfd; }
    th{ background:#4CAF50; color:#fff; font-weight:700; }
    thead th{ position:sticky; top:0; z-index:2; }
    tbody tr:nth-child(even) td{ background:#f9f9f9; }
    tbody tr:hover td{ background:#e6ffe6; }
    td.multiline{ white-space:pre-wrap; overflow-wrap:anywhere; }
    .important-note{ background:#fff3cd; border-left:5px solid #ffe082; padding:10px; margin-top:10px; border-radius:5px; color:#856404; font-size:.85em; }
    @media (max-width:768px){ body{ padding:8px; } .container{ padding:12px; } h1{ font-size:1.5em; } table,thead,tbody,th,td,tr{ display:block; } thead{ display:none; } tr{ border:1px solid #ccc; margin-bottom:10px; padding:8px 6px; border-radius:6px; background:#fff; } td{ border:none; border-bottom:1px solid #eee; text-align:left; padding:6px 2px; } td:last-child{ border-bottom:none; } }
    .hint{font-size:.8em;color:#607d8b;text-align:center;margin-top:8px}
    code.small{background:#eef3f7;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ† 2025 ç¬¬å››å±†å½°åŒ–ç¸£å¥ç¥¥ç›ƒå…¨åœ‹åœæ£‹å…¬é–‹è³½</h1>
    <div class="update-info">è«‹é‡æ–°æ•´ç†é é¢ä»¥æ›´æ–°è³½ç¨‹ï¼š<span id="lastUpdated"></span></div>
    <div class="filter-section">
      <label for="groupSelector">é¸æ“‡çµ„åˆ¥ï¼š</label>
      <select id="groupSelector"></select>
      <button id="refreshBtn" type="button">é‡æ–°è®€å–è³‡æ–™</button>
    </div>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>çµ„åˆ¥</th>
          <th>ç¬¬ä¸€å ´</th>
          <th>ç¬¬äºŒå ´</th>
          <th>ç¬¬ä¸‰å ´</th>
          <th>ç¬¬å››å ´</th>
          <th>ç¬¬äº”å ´</th>
          <th>é ’çæ™‚é–“</th>
          <th>åæ¬¡å…¬ä½ˆ</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="8">è³‡æ–™è¼‰å…¥ä¸­â€¦</td></tr></tbody>
    </table>
    <div id="statusMsg" class="update-info"></div>
    <div class="important-note">
      <strong>æç¤ºï¼š</strong> è‹¥ä½ æ˜¯ä»¥ <code class="small">file://</code> åœ¨æ‰‹æ©Ÿé–‹å•Ÿæœ¬æª”ï¼Œç€è¦½å™¨å¯èƒ½å°é–è·¨ä¾†æºè«‹æ±‚ï¼›æœ¬é æœƒè‡ªå‹•åˆ‡æ› JSONP å¾Œå‚™ä»¥æŒçºŒé‹ä½œã€‚
    </div>
  </div>

  <script>
  // ===== ä½ çš„ Google Apps Script Web App URLï¼ˆå‹™å¿…æ˜¯ /execï¼‰ =====
  const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwBsfiI4tmb-gfi2sxiCXQrFHZL6qt2d5JBLkvfg9CyxTN-9FCAxe40-ssRXPDGG-evEw/exec';

  // ===== è¡Œå‹•ç«¯ç©©å®šï¼šå¯åˆ‡æ› JSONP å¾Œå‚™ =====
  const USE_JSONP_FALLBACK = true;

  // å…§å»ºé è¨­ï¼ˆæŠ“ä¸åˆ°è³‡æ–™æ™‚è‡³å°‘æœ‰é¸å–®/è¡¨æ ¼å¯ä»¥çœ‹ï¼‰
  const defaultScheduleData = [
    { group: "å…­æ®µçµ„", round1: null, round2: null, round3: null, round4: null, round5: null, award: null, "åæ¬¡å…¬ä½ˆ": "" },
    { group: "äº”æ®µçµ„", round1: null, round2: null, round3: null, round4: null, round5: null, award: null, "åæ¬¡å…¬ä½ˆ": "" },
    { group: "å››æ®µçµ„", round1: null, round2: null, round3: null, round4: null, round5: null, award: null, "åæ¬¡å…¬ä½ˆ": "" }
  ];

  const customGroupOrder=["å…­æ®µçµ„","äº”æ®µçµ„","å››æ®µçµ„","ä¸‰æ®µçµ„","äºŒæ®µçµ„","åˆæ®µçµ„","ç”²çµ„","ä¹™çµ„","ä¸™çµ„","ä¸çµ„","æˆŠçµ„","å·±çµ„","åºšçµ„","è¾›Açµ„","è¾›Bçµ„","å…¥é–€Açµ„","å…¥é–€Bçµ„","å¹¼å…’çµ„"];

  // æ”¯æ´å–®æ¬„/å¤šæ¬„åæ¬¡ï¼ˆåˆ¥åï¼‰ â†’ åˆä½µåˆ°é¡¯ç¤ºæ¬„
  const RANK_FIELDS = ["åæ¬¡å…¬ä½ˆ","åæ¬¡å…¬å¸ƒ","ranksCombined","å† è»","äºè»","å­£è»","æ®¿è»","å„ªå‹",
                       "ç¬¬ä¸€å","ç¬¬äºŒå","ç¬¬ä¸‰å","ç¬¬å››å","ç¬¬äº”å","ç¬¬å…­å","ç¬¬ä¸ƒå","ç¬¬å…«å","ç¬¬ä¹å","ç¬¬åå"];

  let allData = []; // ç›®å‰å…¨éƒ¨è³‡æ–™ï¼ˆä¾›ç¯©é¸ï¼‰

  function nowStr(){return new Date().toLocaleString('zh-TW',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});}
  function setStatus(msg){document.getElementById('statusMsg').textContent = msg || '';}

  function normalizeRankBlock(s){
    if (!s) return "";
    let t = String(s).trim();
    if (!t) return "";
    t = t.replace(/[ã€ï¼Œ,ï¼›;ï¼/]\s*/g,'\n');
    t = t.replace(/\s*(å† è»|äºè»|å­£è»|æ®¿è»|å„ªå‹|ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+å)(?:\s*[:ï¼š])?/g,'\n$1ï¼š');
    t = t.split('\n').map(x=>x.trim()).filter(Boolean).join('\n');
    return t;
  }
  function buildRankValue(item){
    const get=(k)=> (k in item && item[k] != null) ? String(item[k]).trim() : "";
    // å–®æ¬„å„ªå…ˆ
    const single = normalizeRankBlock(get("åæ¬¡å…¬ä½ˆ")) || normalizeRankBlock(get("åæ¬¡å…¬å¸ƒ")) || normalizeRankBlock(get("ranksCombined"));
    if (single) return single;
    // å¤šæ¬„åˆä½µ
    const lines = [];
    for (const key of RANK_FIELDS){
      if (key === "åæ¬¡å…¬ä½ˆ" || key === "åæ¬¡å…¬å¸ƒ" || key === "ranksCombined") continue;
      const v = get(key);
      if (v) lines.push(`${key}ï¼š${v}`);
    }
    return lines.length ? normalizeRankBlock(lines.join("\n")) : "æœªå…¬å¸ƒ";
  }

  function populateGroupDropdown(data){
    const sel = document.getElementById('groupSelector');
    const groups = Array.from(new Set(data.map(x=>x.group).filter(Boolean)));
    const known = customGroupOrder.filter(g => groups.includes(g));
    const unknown = groups.filter(g => !customGroupOrder.includes(g)).sort((a,b)=>a.localeCompare(b,'zh-Hant'));

    sel.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = 'all'; optAll.textContent = 'é¡¯ç¤ºæ‰€æœ‰çµ„åˆ¥';
    sel.appendChild(optAll);

    [...known, ...unknown].forEach(g=>{
      const o=document.createElement('option');
      o.value=g; o.textContent=g;
      sel.appendChild(o);
    });
  }

  function sortByCustomOrder(list){
    const orderMap=new Map(customGroupOrder.map((g,i)=>[g,i]));
    return list.slice().sort((a,b)=>{
      const ai=orderMap.has(a.group)?orderMap.get(a.group):9e9;
      const bi=orderMap.has(b.group)?orderMap.get(b.group):9e9;
      if(ai!==bi) return ai-bi;
      return a.group.localeCompare(b.group,'zh-Hant');
    });
  }

  function renderTable(dataToDisplay) {
    const tableBody=document.querySelector('#scheduleTable tbody');
    tableBody.innerHTML='';

    if(dataToDisplay&&dataToDisplay.length>0){
      dataToDisplay.forEach(item=>{
        const row=tableBody.insertRow();
        row.insertCell().textContent=item.group||'';
        row.insertCell().textContent=item.round1||'æœªæ’å®š';
        row.insertCell().textContent=item.round2||'æœªæ’å®š';
        row.insertCell().textContent=item.round3||'æœªæ’å®š';
        row.insertCell().textContent=item.round4||'æœªæ’å®š';
        row.insertCell().textContent=item.round5||'æœªæ’å®š';
        row.insertCell().textContent=item.award||'æœªæ’å®š';
        const rankTd=row.insertCell();
        rankTd.classList.add('multiline');
        rankTd.textContent=buildRankValue(item);
      });
    }else{
      tableBody.innerHTML='<tr><td colspan="8">ç„¡ç¬¦åˆæ¢ä»¶çš„çµ„åˆ¥æ•¸æ“šã€‚</td></tr>';
    }
    document.getElementById('lastUpdated').textContent=nowStr();
  }

  function applyFilterAndRender(){
    const selected = document.getElementById('groupSelector').value;
    let list = allData.slice();
    if (selected !== 'all') list = list.filter(x => x.group === selected);
    list = sortByCustomOrder(list);
    renderTable(list);
  }

  // æ¨™æº– fetchï¼ˆCORSï¼‰
  async function loadDataFetch(){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), 8000);
    const res = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
      cache:'no-store',
      headers:{'Accept':'application/json'},
      mode: 'cors',
      credentials: 'omit',
      signal: controller.signal
    });
    clearTimeout(timer);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('å›å‚³éé™£åˆ—');
    return data;
  }

  // JSONP å¾Œå‚™ï¼ˆæ”¯æ´ file:// on mobileï¼‰
  function loadDataJSONP(){
    return new Promise((resolve,reject)=>{
      const cb = 'jsonp_cb_'+Math.random().toString(36).slice(2);
      window[cb] = function(payload){
        try{
          if (!Array.isArray(payload)) throw new Error('JSONP å›å‚³éé™£åˆ—');
          resolve(payload);
        }catch(e){ reject(e); }
        finally{
          delete window[cb];
          script.remove();
        }
      };
      const sep = GOOGLE_APPS_SCRIPT_WEB_APP_URL.includes('?')?'&':'?';
      const script = document.createElement('script');
      script.src = GOOGLE_APPS_SCRIPT_WEB_APP_URL + sep + 'callback=' + cb;
      script.onerror = () => reject(new Error('JSONP error'));
      document.head.appendChild(script);
    });
  }

  async function loadData(){
    setStatus('è®€å–ä¸­â€¦');
    try{
      let data;
      try{
        data = await loadDataFetch();
        setStatus('è®€å–å®Œæˆ');
      }catch(err){
        if (!USE_JSONP_FALLBACK) throw err;
        console.warn('CORS å¤±æ•—ï¼Œå•Ÿç”¨ JSONP å¾Œå‚™ï¼š', err);
        data = await loadDataJSONP();
        setStatus('è®€å–å®Œæˆ');
      }
      allData = data;
    }catch(e){
      console.error(e);
      allData = defaultScheduleData.slice();
      setStatus('è®€å–å¤±æ•—ï¼šé¡¯ç¤ºé è¨­è³‡æ–™');
    }finally{
      populateGroupDropdown(allData);
      applyFilterAndRender();
    }
  }

  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('groupSelector').addEventListener('change', applyFilterAndRender);
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    loadData();
  });
  </script>
</body>
</html>
