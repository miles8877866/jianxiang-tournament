<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025 第四屆彰化縣健祥盃全國圍棋公開賽｜賽程 & 名次</title>
  <style>
    body { font-family: 'Noto Sans TC','Microsoft JhengHei',system-ui,sans-serif; margin:0; padding:10px; background:#f4f7f6; color:#333; }
    .container { max-width:900px; margin:0 auto; background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    h1 { color:#2c3e50; text-align:center; margin:0 0 16px; font-size:1.8em; line-height:1.2; }
    .update-info{ text-align:center; margin-bottom:12px; font-size:.85em; color:#7f8c8d; }
    .filter-section{ display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:12px; flex-wrap:wrap; }
    .filter-section select,.filter-section button{ padding:6px 10px; border:1px solid #ccc; border-radius:6px; font-size:.9em; background:#fff; cursor:pointer; }
    .filter-section button{ background:#2e7d32; color:#fff; border:none; }
    table{ width:100%; border-collapse:collapse; margin-bottom:12px; font-size:.9em; table-layout:auto; }
    th,td{ border:1px solid #ddd; padding:6px 4px; text-align:center; vertical-align:top; line-height:1.4; background:#fdfdfd; white-space:nowrap; word-break:keep-all; }
    th{ background:#4CAF50; color:#fff; font-weight:700; }
    thead th{ position:sticky; top:0; z-index:2; }
    tbody tr:nth-child(even) td{ background:#f9f9f9; }
    tbody tr:hover td{ background:#e6ffe6; }
    td.multiline{ white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; } /* 修正 v3 版缺失的大括號與重複屬性 */

    .important-note{ background:#fff3cd; border-left:5px solid #ffe082; padding:10px; margin-top:10px; border-radius:5px; color:#856404; font-size:.85em; }

    /* === AutoFit on mobile（修正：避免偏右、sticky 漂浮、時間拆字） === */
    @media (max-width:768px){
      body{ padding:8px; } .container{ padding:12px; } h1{ font-size:1.5em; }

      .table-autofit{ overflow:hidden; text-align:left; }
      .table-autofit .autofit-inner{
        display:inline-block;              /* 關鍵：避免縮放後視覺寬與實際寬不一致造成位移 */
        transform-origin: top left;
        transform: scale(1);
      }

      /* sticky 在 transform 環境下常失效 → 手機停用 sticky，體感更穩 */
      thead th{ position:static !important; }

      /* 手機把字級/內距再小一點，AutoFit 更好塞下 */
      #scheduleTable th, #scheduleTable td{ font-size:12px; padding:4px 3px; }

      /* 保留名次欄可換行，其它欄位不拆字（避免 10:30 被拆） */
      #scheduleTable td.multiline{ white-space:pre-wrap !important; word-break:break-word; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏆 2025 第四屆彰化縣健祥盃全國圍棋公開賽</h1>
    <div class="update-info">請重新整理頁面以更新賽程：<span id="lastUpdated"></span></div>

    <div class="filter-section">
      <label for="groupSelector">選擇組別：</label>
      <select id="groupSelector"></select>
      <button id="refreshBtn" type="button">重新讀取資料</button>
    </div>

    <!-- AutoFit wrapper -->
    <div id="tableFit" class="table-autofit">
      <div class="autofit-inner">
        <table id="scheduleTable">
          <thead>
            <tr>
              <th>組別</th>
              <th>第一場</th>
              <th>第二場</th>
              <th>第三場</th>
              <th>第四場</th>
              <th>第五場</th>
              <th>頒獎時間</th>
              <th>名次公佈</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="8">資料載入中…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div id="statusMsg" class="update-info"></div>
    <div class="important-note"><strong>重要提示：</strong> 各場次開賽時間將依實際比賽進度動態調整，請隨時留意本頁面最新公告！頒獎時間為預估，實際頒獎時間請依現場廣播為準。名次資訊將於比賽結束後陸續更新。</div>
  </div>

  <script>
  const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzSR0BkM6wfPITIozHvWKY7MO1ynwtp2WN9QwEhdElrU292_OWXey64HArlZsFJ3TC6og/exec';
  const RANK_FIELDS = ["名次公佈","名次公布","冠軍","亞軍","季軍","殿軍","優勝","第一名","第二名","第三名","第四名","第五名","第六名","第七名","第八名","第九名","第十名"];
  const defaultScheduleData = [{ group:"六段組" },{ group:"五段組" },{ group:"四段組" }];
  const customGroupOrder = ["六段組","五段組","四段組","三段組","二段組","初段組","甲組","乙組","丙組","丁組","戊組","己組","庚組","辛A組","辛B組","入門A組","入門B組","幼兒組"];
  let allData = [];

  function nowStr(){ return new Date().toLocaleString('zh-TW',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}); }
  function setStatus(msg){ document.getElementById('statusMsg').textContent = msg || ''; }
  function normalizeRankBlock(s){ if(!s) return ""; let t=String(s).trim(); if(!t) return ""; t=t.replace(/[、，,；;／/]\s*/g,"\n"); t=t.replace(/\s*(冠軍|亞軍|季軍|殿軍|優勝|第[一二三四五六七八九十]+名)(?:\s*[:：])?/g,"\n$1："); t=t.split("\n").map(x=>x.trim()).filter(Boolean).join("\n"); return t; }
  function buildRankValue(item){ const get=k=>(k in item&&item[k]!=null)?String(item[k]).trim():""; const single=normalizeRankBlock(get("名次公佈"))||normalizeRankBlock(get("名次公布"))||normalizeRankBlock(get("ranksCombined")); if(single) return single; const lines=[]; for(const key of RANK_FIELDS){ if(key==="名次公佈"||key==="名次公布") continue; const v=get(key); if(v) lines.push(`${key}：${v}`);} return lines.length?normalizeRankBlock(lines.join("\n")):"未公布"; }
  function populateGroupDropdown(data){ const sel=document.getElementById("groupSelector"); const groups=Array.from(new Set(data.map(x=>x.group).filter(Boolean))); const known=customGroupOrder.filter(g=>groups.includes(g)); const unknown=groups.filter(g=>!customGroupOrder.includes(g)).sort((a,b)=>a.localeCompare(b,"zh-Hant")); sel.innerHTML=""; const optAll=document.createElement("option"); optAll.value="all"; optAll.textContent="顯示所有組別"; sel.appendChild(optAll); [...known,...unknown].forEach(g=>{ const o=document.createElement("option"); o.value=g; o.textContent=g; sel.appendChild(o); }); }
  function sortByCustomOrder(list){ const orderMap=new Map(customGroupOrder.map((g,i)=>[g,i])); return list.slice().sort((a,b)=>{ const ai=orderMap.has(a.group)?orderMap.get(a.group):9e9; const bi=orderMap.has(b.group)?orderMap.get(b.group):9e9; if(ai!==bi) return ai-bi; return a.group.localeCompare(b.group,"zh-Hant"); }); }
  function renderTable(dataToDisplay){ const tbody=document.querySelector("#scheduleTable tbody"); tbody.innerHTML=""; const list=dataToDisplay&&dataToDisplay.length?dataToDisplay:[]; if(!list.length){ tbody.innerHTML='<tr><td colspan="8">無符合條件的組別數據。</td></tr>'; document.getElementById("lastUpdated").textContent=nowStr(); return;} list.forEach(item=>{ const tr=document.createElement("tr"); tr.insertCell().textContent=item.group||""; tr.insertCell().textContent=item.round1||"未排定"; tr.insertCell().textContent=item.round2||"未排定"; tr.insertCell().textContent=item.round3||"未排定"; tr.insertCell().textContent=item.round4||"未排定"; tr.insertCell().textContent=item.round5||"未排定"; tr.insertCell().textContent=item.award||"未排定"; const tdRank=document.createElement("td"); tdRank.classList.add("multiline"); tdRank.innerHTML=buildRankValue(item).replace(/\n/g,"<br>"); tr.appendChild(tdRank); tbody.appendChild(tr); }); document.getElementById("lastUpdated").textContent=nowStr(); autoFitTable(); }
  function applyFilterAndRender(){ const selected=document.getElementById("groupSelector").value; let list=allData.slice(); if(selected!=="all") list=list.filter(x=>x.group===selected); list=sortByCustomOrder(list); renderTable(list); }
  async function loadData(){ setStatus("正在讀取資料…"); try{ const res=await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL,{cache:"no-store",headers:{"Accept":"application/json"}}); if(!res.ok) throw new Error("HTTP "+res.status); const data=await res.json(); allData=Array.isArray(data)?data:[]; if(!allData.length) throw new Error("空資料"); setStatus("資料更新完成（"+nowStr()+"）"); }catch(err){ console.error(err); allData=defaultScheduleData.slice(); setStatus("讀取失敗：顯示預設資料。"); }finally{ populateGroupDropdown(allData); applyFilterAndRender(); } }

  // AutoFit
  function autoFitTable(){
    const wrap=document.getElementById("tableFit");
    const inner=wrap?.querySelector(".autofit-inner");
    if(!wrap||!inner) return;
    const isMobile=window.matchMedia("(max-width: 768px)").matches;
    inner.style.transform="scale(1)";
    const wrapW=wrap.clientWidth;
    const contentW=inner.scrollWidth;
    let scale=isMobile?Math.min(1,wrapW/contentW):1;
    const MIN_SCALE=0.65; // 降低最小縮放比，避免時間/表頭被拆字
    scale=Math.max(scale,MIN_SCALE);
    inner.style.transform=`scale(${scale})`;
    requestAnimationFrame(()=>{
      wrap.style.height=(inner.getBoundingClientRect().height)+"px";
      wrap.style.width=wrap.clientWidth+"px"; // 額外保險，避免 reflow 造成水平位移
    });
  }
  window.addEventListener("resize", autoFitTable);

  document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("groupSelector").addEventListener("change", applyFilterAndRender);
    document.getElementById("refreshBtn").addEventListener("click", loadData);
    loadData();
  });
  </script>
</body>
</html>
